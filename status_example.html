<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mediainbox XDR Status</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
        }

        .status-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            height: auto;
            min-height: 200px;
        }

        .status-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .status-card h2 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 1.2em;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px 10px;
            font-size: 0.9em;
        }

        .status-item {
            font-size: 0.9em;
            color: #555;
            margin: 4px 0;
        }

        .status-label {
            display: block;
            font-size: 0.8em;
            color: #7f8c8d;
            margin-bottom: 2px;
        }

        .status-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.05em;
        }

        .frequency {
            color: #2980b9;
            font-weight: bold;
        }

        .volume-level {
            color: #27ae60;
            font-weight: bold;
        }

        .squelch {
            color: #e74c3c;
            font-weight: bold;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .loading {
            font-size: 18px;
            color: #7f8c8d;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-card" id="status-1">
            <h2>Receiver 1</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Frequency</span>
                    <span class="status-value frequency" id="freq-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Volume</span>
                    <span class="status-value volume-level" id="volume-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Squelch</span>
                    <span class="status-value squelch" id="squelch-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Bandwidth</span>
                    <span class="status-value" id="bandwidth-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">AGC</span>
                    <span class="status-value" id="agc-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Antenna</span>
                    <span class="status-value" id="antenna-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">DAA</span>
                    <span class="status-value" id="daa-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Deemphasis</span>
                    <span class="status-value" id="deemphasis-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Gain</span>
                    <span class="status-value" id="gain-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Int. Detector</span>
                    <span class="status-value" id="interval-detector-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Int. Sampling</span>
                    <span class="status-value" id="interval-sampling-1">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Rotator</span>
                    <span class="status-value" id="rotator-1">Loading...</span>
                </div>
            </div>
        </div>

        <div class="status-card" id="status-2">
            <h2>Receiver 2</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Frequency</span>
                    <span class="status-value frequency" id="freq-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Volume</span>
                    <span class="status-value volume-level" id="volume-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Squelch</span>
                    <span class="status-value squelch" id="squelch-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Bandwidth</span>
                    <span class="status-value" id="bandwidth-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">AGC</span>
                    <span class="status-value" id="agc-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Antenna</span>
                    <span class="status-value" id="antenna-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">DAA</span>
                    <span class="status-value" id="daa-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Deemphasis</span>
                    <span class="status-value" id="deemphasis-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Gain</span>
                    <span class="status-value" id="gain-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Int. Detector</span>
                    <span class="status-value" id="interval-detector-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Int. Sampling</span>
                    <span class="status-value" id="interval-sampling-2">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Rotator</span>
                    <span class="status-value" id="rotator-2">Loading...</span>
                </div>
            </div>
        </div>

        <div class="status-card" id="status-3">
            <h2>Receiver 3</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Frequency</span>
                    <span class="status-value frequency" id="freq-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Volume</span>
                    <span class="status-value volume-level" id="volume-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Squelch</span>
                    <span class="status-value squelch" id="squelch-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Bandwidth</span>
                    <span class="status-value" id="bandwidth-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">AGC</span>
                    <span class="status-value" id="agc-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Antenna</span>
                    <span class="status-value" id="antenna-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">DAA</span>
                    <span class="status-value" id="daa-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Deemphasis</span>
                    <span class="status-value" id="deemphasis-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Gain</span>
                    <span class="status-value" id="gain-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Int. Detector</span>
                    <span class="status-value" id="interval-detector-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Int. Sampling</span>
                    <span class="status-value" id="interval-sampling-3">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Rotator</span>
                    <span class="status-value" id="rotator-3">Loading...</span>
                </div>
            </div>
        </div>

        <div class="status-card" id="status-4">
            <h2>Receiver 4</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Frequency</span>
                    <span class="status-value frequency" id="freq-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Volume</span>
                    <span class="status-value volume-level" id="volume-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Squelch</span>
                    <span class="status-value squelch" id="squelch-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Bandwidth</span>
                    <span class="status-value" id="bandwidth-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">AGC</span>
                    <span class="status-value" id="agc-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Antenna</span>
                    <span class="status-value" id="antenna-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">DAA</span>
                    <span class="status-value" id="daa-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Deemphasis</span>
                    <span class="status-value" id="deemphasis-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Gain</span>
                    <span class="status-value" id="gain-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Int. Detector</span>
                    <span class="status-value" id="interval-detector-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Int. Sampling</span>
                    <span class="status-value" id="interval-sampling-4">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Rotator</span>
                    <span class="status-value" id="rotator-4">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urls = [
            'http://127.0.0.1:5000/api/state/1',
            'http://127.0.0.1:5000/api/state/2',
            'http://127.0.0.1:5000/api/state/3',
            'http://127.0.0.1:5000/api/state/4'
        ];

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Helper function to safely update a field if the element exists
        function updateField(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value !== undefined ? value : 'N/A';
                return true;
            }
            return false;
        }

        function fetchData(url, statusId) {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!data) throw new Error('No data received');

                    // Update frequency with kHz (format: '96950,10')
                    if (data.freq_khz) {
                        try {
                            const freqParts = String(data.freq_khz).split(',');
                            const freqValue = parseInt(freqParts[0]) || 0;
document.getElementById(`freq-${statusId}`).textContent = `${(freqValue / 1000).toFixed(2)} MHz`;
                        } catch (e) {
                            console.error('Error parsing frequency:', e);
                            updateField('freq', 'N/A');
                        }
                    }

                    // Update volume with percentage
                    const volume = data.volume !== undefined ? `${data.volume}%` : 'N/A';
                    document.getElementById(`volume-${statusId}`).textContent = volume;

                    // Update squelch display (0 = OFF, 1-100 = threshold value)
                    if (data.squelch !== undefined) {
                        const squelchText = data.squelch === 0 ? 'OFF' : data.squelch.toString();
                        document.getElementById(`squelch-${statusId}`).textContent = squelchText;
                    }

                    // Update bandwidth in kHz
                    if (data.bandwidth !== undefined) {
                        const bandwidthKHz = (parseInt(data.bandwidth) || 0) / 1000;
                        document.getElementById(`bandwidth-${statusId}`).textContent = `${bandwidthKHz} kHz`;
                    }

                    // Update AGC (0=OFF, 1=FAST, 2=MED, 3=SLOW)
                    const agcModes = ['OFF', 'FAST', 'MED', 'SLOW'];
                    const agcValue = data.agc !== undefined ? (agcModes[data.agc] || data.agc) : 'N/A';
                    document.getElementById(`agc-${statusId}`).textContent = agcValue;

                    // Update antenna (0=Auto, 1=Ant1, 2=Ant2)
                    const antennas = ['Auto', 'Ant1', 'Ant2'];
                    const antennaValue = data.antenna !== undefined ? (antennas[data.antenna] || data.antenna) : 'N/A';
                    document.getElementById(`antenna-${statusId}`).textContent = antennaValue;

                    // Update DAA (dynamic attenuation adjustment)
                    const daaValue = data.daa ? 
                        data.daa.charAt(0).toUpperCase() + data.daa.slice(1) : 'N/A';
                    document.getElementById(`daa-${statusId}`).textContent = daaValue;

                    // Update deemphasis
                    document.getElementById(`deemphasis-${statusId}`).textContent = data.deemphasis || 'N/A';

                    // Hide fields that don't exist in the API response
                    ['gain', 'interval-detector', 'interval-sampling', 'rotator'].forEach(field => {
                        const element = document.getElementById(`${field}-${statusId}`);
                        if (element) {
                            element.parentElement.style.display = 'none';
                        }
                    });

                    // Update card styling
                    const card = document.getElementById(`status-${statusId}`);
                    if (card) {
                        // Default to green border
                        let borderColor = '#2ecc71';
                        
                        // Update based on squelch if available
                        if (data.squelch !== undefined) {
                            // New format: 0 = off, 1-100 = on with threshold
                            if (data.squelch === 0) {
                                borderColor = '#e74c3c'; // Red for squelch off
                            }
                        }
                        
                        // Update based on signal level if available
                        if (data.signal_level !== undefined) {
                            const signalLevel = parseFloat(data.signal_level) || 0;
                            borderColor = signalLevel > 10 ? '#27ae60' : 
                                         signalLevel > 5 ? '#f39c12' : '#e74c3c';
                        }
                        
                        card.style.borderLeft = `4px solid ${borderColor}`;
                    }
                })
                .catch(error => {
                    console.error(`Error fetching data for Receiver ${statusId}:`, error);
                    const errorText = 'Error';
                    const fields = [
                        'freq', 'volume', 'squelch', 'bandwidth', 'agc', 'antenna',
                        'daa', 'deemphasis', 'gain', 'interval-detector', 'interval-sampling', 'rotator'
                    ];

                    fields.forEach(field => {
                        const element = document.getElementById(`${field}-${statusId}`);
                        if (element) {
                            element.textContent = errorText;
                        }
                    });

                    // Set error state styling
                    const card = document.getElementById(`status-${statusId}`);
                    if (card) {
                        card.style.borderLeft = '4px solid #f39c12';
                    }
                });
        }

        // Load data for each status with delay
        async function loadDataWithDelay() {
            // First load immediately
            for (let i = 0; i < urls.length; i++) {
                fetchData(urls[i], i + 1);
                await sleep(1000); // 1 second delay between initial loads
            }
            
            // Then refresh every 10 seconds
            setInterval(() => {
                for (let i = 0; i < urls.length; i++) {
                    fetchData(urls[i], i + 1);
                }
            }, 10000);
        }

        // Start loading data
        loadDataWithDelay();
    </script>
</body>
</html>
